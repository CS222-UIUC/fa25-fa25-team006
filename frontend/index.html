<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CampusCache - UIUC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- React via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Leaflet (map, no keys) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      /* UIUC Official Colors */
      --uiuc-blue:#13294B;
      --uiuc-orange:#FF5F05;
      --uiuc-blue-light:#7C95C4;
      --uiuc-blue-dark:#0A1A2E;
      
      /* Light mode */
      --bg:#f5f5f5;
      --panel:#ffffff;
      --muted:#6c757d;
      --text:#13294B;
      --brand:var(--uiuc-orange);
      --accent:var(--uiuc-orange);
      --border:#dee2e6;
      --chip:#f8f9fa;
      --btn:var(--uiuc-orange);
      --btn-ghost:#f8f9fa;
      --shadow: 0 4px 16px rgba(19, 41, 75, 0.1);
      --radius:12px;
    }
    
    /* Dark mode */
    [data-theme="dark"] {
      --bg:#0a1a2e;
      --panel:#12161c;
      --muted:#9aa4b2;
      --text:#e8edf3;
      --border:#1d242d;
      --chip:#1a212b;
      --btn-ghost:#1a212b;
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg, #f8f9fa 0%, #ffffff 100%);
      color:var(--text); font: 15px/1.5 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    [data-theme="dark"] body {
      background: linear-gradient(180deg, #0a1a2e 0%, #12161c 100%);
    }

    /* Top bar - UIUC themed */
    .appbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(140%) blur(10px);
      background:var(--uiuc-blue); border-bottom:3px solid var(--uiuc-orange);
      box-shadow: 0 2px 8px rgba(19, 41, 75, 0.2);
    }
    .appbar-inner{
      max-width:1080px; margin:0 auto; padding:14px 18px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    
    .dark-mode-toggle {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    
    .dark-mode-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--uiuc-orange);
    }
    
    .dark-mode-toggle svg {
      width: 16px;
      height: 16px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.2px; color:#ffffff}
    .badge{font-size:12px; padding:2px 8px; border-radius:999px; background:var(--uiuc-orange); border:none; color:#ffffff; font-weight:600}

    .container{max-width:1080px; margin:18px auto; padding:0 18px}
    .panel{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); border-top:3px solid var(--uiuc-orange); transition: background-color 0.3s ease, border-color 0.3s ease}

    /* Controls */
    .controls{ padding:16px; display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .input{
      background:var(--panel); border:1px solid var(--border); color:var(--text);
      padding:10px 12px; border-radius:10px; outline:none; min-width:220px;
      transition: border-color 0.2s ease, background-color 0.3s ease, color 0.3s ease;
    }
    .input:focus{border-color:var(--uiuc-orange); box-shadow: 0 0 0 3px rgba(255, 95, 5, 0.1);}
    .input.small{min-width:100px; width:110px}
    .btn{
      border:0; padding:10px 18px; border-radius:10px; cursor:pointer; font-weight:600;
      transition:.15s all ease;
    }
    .btn:hover{transform:translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15);}
    .btn:active{transform:translateY(0)}
    .btn-primary{background:var(--uiuc-orange); color:#fff}
    .btn-primary:hover{background:#e85505; box-shadow: 0 4px 12px rgba(255, 95, 5, 0.3);}
    .btn-ghost{background:var(--btn-ghost); color:var(--uiuc-blue); border:1px solid var(--border)}
    .btn-ghost:hover{background:#e9ecef; border-color:var(--uiuc-orange);}
    .btn-warning{background:var(--uiuc-orange); color:#fff}

    /* Map */
    #map{ height:360px; width:100%; border-radius:calc(var(--radius) - 2px); overflow:hidden }
    .map-wrap{ padding:10px; }

    /* Sections */
    h2{margin:14px 16px 8px; font-size:20px; letter-spacing:.2px; color:var(--uiuc-blue); font-weight:700; border-bottom:2px solid var(--uiuc-orange); padding-bottom:8px}
    .grid{
      display:grid; gap:12px; padding:10px;
      grid-template-columns: repeat(auto-fill, minmax(280px,1fr));
    }

    /* Cards */
    .card{
      background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px;
      box-shadow: 0 2px 8px rgba(19, 41, 75, 0.08);
      display:flex; flex-direction:column; gap:12px;
      transition: box-shadow 0.2s ease, transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
    }
    
    [data-theme="dark"] .card {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    .card:hover{box-shadow: 0 4px 16px rgba(19, 41, 75, 0.12); transform: translateY(-2px);}
    .row{display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .title{font-weight:700; color:var(--uiuc-blue)}
    .meta{color:var(--muted); font-size:12px}
    .chips{display:flex; flex-wrap:wrap; gap:6px}
    .chip{background:var(--uiuc-blue-light); border:none; color:var(--uiuc-blue); padding:4px 10px; border-radius:999px; font-size:12px; font-weight:500}
    .coords{color:var(--muted); font-family:ui-monospace, Menlo, Consolas, monospace; font-size:12px}

    /* Toast */
    .toast{
      position:fixed; bottom:16px; right:16px; background:var(--uiuc-blue); border:2px solid var(--uiuc-orange);
      padding:12px 16px; border-radius:10px; color:#ffffff; box-shadow:var(--shadow); opacity:0; transform:translateY(8px);
      transition:.2s ease; pointer-events:none; font-weight:500;
    }
    .toast.show{opacity:1; transform:translateY(0)}
  </style>
</head>
<body>
  <div class="appbar">
    <div class="appbar-inner">
      <div class="brand">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="#FF5F05" aria-hidden="true"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l8 4v8.64l-8 4-8-4V8.18l8-4z"/></svg>
        CampusCache <span class="badge">UIUC</span>
      </div>
      <div style="display:flex; gap:12px; align-items:center;">
        <div id="auth-spot"></div>
        <button class="dark-mode-toggle" id="dark-mode-toggle" aria-label="Toggle dark mode">
          <svg id="dark-icon" viewBox="0 0 24 24" fill="currentColor" style="display:none;">
            <path fillRule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10 10 0 01-19.47 0 .75.75 0 01.982-.98zM17.25 16.5a.75.75 0 00.75-.75v-3a.75.75 0 00-1.5 0v3a.75.75 0 00.75.75z" clipRule="evenodd"/>
          </svg>
          <svg id="light-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
          </svg>
          <span id="dark-mode-text">Dark</span>
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <div class="controls" id="controls-spot"></div>
      <div class="map-wrap"><div id="map"></div></div>
    </div>

    <div class="panel" style="margin-top:14px" id="recs-panel">
      <h2>Recommendations</h2>
      <div class="grid" id="recs-spot"></div>
    </div>

    <div class="panel" style="margin-top:14px">
      <h2>Nearby Caches</h2>
      <div class="grid" id="grid-spot"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const e = React.createElement;

    // Dark mode functionality
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = saved ? saved === 'dark' : prefersDark;
      
      if (isDark) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('dark-icon').style.display = 'none';
        document.getElementById('light-icon').style.display = 'block';
        document.getElementById('dark-mode-text').textContent = 'Light';
      }
      
      document.getElementById('dark-mode-toggle').addEventListener('click', function() {
        const root = document.documentElement;
        const isDark = root.getAttribute('data-theme') === 'dark';
        
        if (isDark) {
          root.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          document.getElementById('dark-icon').style.display = 'none';
          document.getElementById('light-icon').style.display = 'block';
          document.getElementById('dark-mode-text').textContent = 'Dark';
        } else {
          root.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          document.getElementById('dark-icon').style.display = 'block';
          document.getElementById('light-icon').style.display = 'none';
          document.getElementById('dark-mode-text').textContent = 'Light';
        }
      });
    })();

    // Simple token store
    const tokenStore = {
      get: () => localStorage.getItem("token") || "",
      set: (t) => localStorage.setItem("token", t || ""),
      clear: () => localStorage.removeItem("token"),
    };

    function toast(msg){
      const el=document.getElementById('toast');
      el.textContent=msg; el.classList.add('show');
      setTimeout(()=>el.classList.remove('show'),1600);
    }

    function useApi() {
      const j = (r) => { if(!r.ok) throw new Error("HTTP " + r.status); return r.json(); };
      const h = () => {
        const t = tokenStore.get();
        return t ? { "Content-Type":"application/json", "Authorization": `Bearer ${t}` } : { "Content-Type":"application/json" };
      };
      return {
        me:   () => fetch('/api/me', { headers: h() }).then(j),
        login:(u,p)=> fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({username:u,password:p}) }).then(j),
        logout: () => fetch('/api/logout', { method:'POST', headers: h() }).then(j),
        list: (q, box) => fetch(`/api/caches?q=${encodeURIComponent(q||"")}${box||""}`).then(j),
        toggleFav: (cacheId) => fetch('/api/favorites/toggle', {method:'POST', headers: h(), body: JSON.stringify({cacheId})}).then(j),
        favs: () => fetch('/api/favorites', { headers: h() }).then(j),
        finds: (cacheId, note) => fetch('/api/finds', {method:'POST', headers: h(), body: JSON.stringify({cacheId, note})}).then(j),
        recs: () => fetch('/api/recommendations', { headers: h() }).then(j),
        like: (cacheId) => fetch(`/api/caches/${cacheId}/like`, {method:'POST', headers: h()}).then(j),
        unlike: (cacheId) => fetch(`/api/caches/${cacheId}/like`, {method:'DELETE', headers: h()}).then(j),
        liked: () => fetch('/api/me/liked', { headers: h() }).then(j),
      };
    }

    function useLeafletMap(center=[40.11,-88.227], zoom=14) {
      const mapRef = React.useRef(null);
      const layerRef = React.useRef(null);

      React.useEffect(() => {
        mapRef.current = L.map('map', { zoomControl: false }).setView(center, zoom);
        L.control.zoom({ position: 'bottomright' }).addTo(mapRef.current);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap'
        }).addTo(mapRef.current);
        layerRef.current = L.layerGroup().addTo(mapRef.current);
        return () => mapRef.current?.remove();
      }, []);

      const setMarkers = (points=[]) => {
        if (!layerRef.current) return;
        layerRef.current.clearLayers();
        points.forEach(p => {
          const lat = p.latitude || p.lat || 0;
          const lon = p.longitude || p.lon || 0;
          const m = L.marker([lat, lon]).bindPopup(
            `<strong>${p.title}</strong><br/>${p.category || 'general'} • diff ${p.difficulty || 1}<br/><small>#${p.id}</small>`
          );
          layerRef.current.addLayer(m);
        });
      };

      const fitToPoints = (points=[]) => {
        if (!mapRef.current || !points.length) return;
        const bounds = L.latLngBounds(points.map(p => [p.latitude || p.lat || 0, p.longitude || p.lon || 0]));
        mapRef.current.fitBounds(bounds.pad(0.25));
      };

      return { setMarkers, fitToPoints };
    }

    function App(){
      const api = useApi();
      const [me, setMe] = React.useState(null);
      const [loginErr, setLoginErr] = React.useState("");
      const [username, setUsername] = React.useState("");
      const [password, setPassword] = React.useState("");

      const [q, setQ] = React.useState("");
      const [lat, setLat] = React.useState("40.1100");
      const [lon, setLon] = React.useState("-88.2272");
      const [delta, setDelta] = React.useState("0.02");
      const [rows, setRows] = React.useState([]);
      const [favs, setFavs] = React.useState([]);
      const [recs, setRecs] = React.useState([]);
      const [loading, setLoading] = React.useState(false);

      const map = useLeafletMap();
      const bbox = () => `&lat=${lat}&lon=${lon}&delta=${delta}`;

      const loadPublic = async () => {
        setLoading(true);
        try {
          const list = await api.list(q, bbox());
          setRows(list);
          map.setMarkers(list); map.fitToPoints(list);
        } catch(e){ toast(e.message); }
        finally{ setLoading(false); }
      };

      const loadAuthed = async () => {
        if (!me) return;
        try {
          const [fav, rec] = await Promise.all([api.favs(), api.recs()]);
          setFavs(fav); setRecs(rec);
        } catch {}
      };

      React.useEffect(() => {
        (async () => {
          const t = tokenStore.get();
          if (t) {
            try { const who = await api.me(); setMe(who); } catch { tokenStore.clear(); }
          }
          await loadPublic(); await loadAuthed();
        })();
      }, []);

      const isFav = (id) => favs.some(f => f.id === id);
      const isLiked = (id) => {
        const cache = rows.find(c => c.id === id) || recs.find(c => c.id === id);
        return cache?.is_liked || false;
      };
      const getLikeCount = (id) => {
        const cache = rows.find(c => c.id === id) || recs.find(c => c.id === id);
        return cache?.like_count || 0;
      };
      
      const handleLike = async (cacheId) => {
        if (!me) {
          toast('Log in to like caches');
          return;
        }
        try {
          const cache = rows.find(c => c.id === cacheId) || recs.find(c => c.id === cacheId);
          const isLiked = cache?.is_liked;
          if (isLiked) {
            await api.unlike(cacheId);
            // Update local state for both rows and recs
            setRows(rows.map(c => c.id === cacheId ? {...c, is_liked: false, like_count: Math.max(0, (c.like_count || 0) - 1)} : c));
            setRecs(recs.map(c => c.id === cacheId ? {...c, is_liked: false, like_count: Math.max(0, (c.like_count || 0) - 1)} : c));
            toast('Unliked');
          } else {
            await api.like(cacheId);
            // Update local state for both rows and recs
            setRows(rows.map(c => c.id === cacheId ? {...c, is_liked: true, like_count: (c.like_count || 0) + 1} : c));
            setRecs(recs.map(c => c.id === cacheId ? {...c, is_liked: true, like_count: (c.like_count || 0) + 1} : c));
            toast('Liked!');
          }
        } catch(e) {
          toast(e.message || 'Failed to update like');
        }
      };

      const handleLogin = async (e)=>{
        e.preventDefault(); setLoginErr("");
        try{
          const r = await api.login(username, password);
          tokenStore.set(r.access_token); 
          const who = await api.me(); 
          setMe(who); 
          setUsername(""); setPassword("");
          toast(`Welcome, ${who.username}!`);
          await loadPublic(); await loadAuthed();
        }catch{ setLoginErr("Invalid username or password"); }
      };
      const handleLogout = async ()=>{
        await api.logout(); tokenStore.clear(); setMe(null); setFavs([]); setRecs([]); toast("Logged out");
      };

      return e(React.Fragment,null,
        // Auth bar (in appbar right side)
        ReactDOM.createPortal(
          me
          ? e('div',{className:'row'},
              e('span',null, 'Signed in as ', e('strong',null, me.username)),
              e('button',{className:'btn btn-ghost', onClick:handleLogout},'Log out'))
          : e('form',{className:'row', onSubmit:handleLogin},
              e('input',{className:'input', placeholder:'username (admin or alex)', value:username, onChange:e=>setUsername(e.target.value)}),
              e('input',{className:'input', type:'password', placeholder:'password', value:password, onChange:e=>setPassword(e.target.value)}),
              e('button',{className:'btn btn-primary', type:'submit'}, 'Log in'),
              loginErr && e('span',{style:{color:'var(--uiuc-orange)', marginLeft:6, fontWeight:500}}, loginErr)
            ),
          document.getElementById('auth-spot')
        ),

        // Controls
        ReactDOM.createPortal(
          e('div', {className:'row', style:{width:'100%'}},
            e('input',{className:'input', placeholder:'Search title, category, tag…', value:q, onChange:e=>setQ(e.target.value), style:{flex:'1 1 280px'}}),
            e('input',{className:'input small', placeholder:'lat', value:lat, onChange:e=>setLat(e.target.value)}),
            e('input',{className:'input small', placeholder:'lon', value:lon, onChange:e=>setLon(e.target.value)}),
            e('input',{className:'input small', placeholder:'delta', value:delta, onChange:e=>setDelta(e.target.value)}),
            e('button',{className:'btn btn-primary', onClick:()=>{ loadPublic(); if(me) loadAuthed(); }}, loading?'Loading…':'Refresh')
          ),
          document.getElementById('controls-spot')
        ),

        // Recommendations (grid)
        ReactDOM.createPortal(
          (me && recs.length>0)
            ? recs.slice(0,6).map(c => e('div',{className:'card', key:'rec-'+c.id},
                e('div',{className:'row'},
                  e('div',null,
                    e('div',{className:'title'}, c.title,' ', e('span',{className:'meta'}, `#${c.id}`)),
                    e('div',{className:'meta'}, `${c.category || 'general'} • diff ${c.difficulty || 1}`)
                  ),
                  e('div',{style:{display:'flex', gap:'8px', alignItems:'center'}},
                    e('button',{className:'btn btn-ghost', onClick:()=>api.finds(c.id,'from rec').then(()=>{ loadPublic(); loadAuthed(); toast('Find logged'); })}, 'Log find'),
                    e('button',{className:'btn', style:{background: isFav(c.id)?'var(--uiuc-blue)': 'var(--btn)'}, onClick:()=>api.toggleFav(c.id).then(()=>{ loadAuthed(); toast(isFav(c.id)?'Removed':'Saved'); })}, isFav(c.id)?'★ Unsave':'☆ Save'),
                    e('button',{className:'btn btn-ghost', style:{background: c.is_liked?'#ff6b6b':'transparent', color: c.is_liked?'#fff':'inherit', minWidth:'60px'}, onClick:()=>handleLike(c.id)}, `❤️ ${c.like_count || 0}`)
                  )
                ),
                e('div',{className:'chips'}, (c.tags || []).map(t => e('span',{className:'chip', key:t}, t)))
              ))
            : e('div',{className:'meta', style:{padding:'0 12px 12px'}}, me ? 'No recommendations yet — save a few favorites.' : 'Log in to see recommendations.'),
          document.getElementById('recs-spot')
        ),

        // Nearby grid
        ReactDOM.createPortal(
          (rows || []).map(c => e('div',{className:'card', key:c.id},
            e('div',{className:'row'},
              e('div',null,
                e('div',{className:'title'}, c.title,' ', e('span',{className:'meta'}, `#${c.id}`)),
                e('div',{className:'meta'}, `${c.category || 'general'} • diff ${c.difficulty || 1}`)
              ),
              e('div',{style:{display:'flex', gap:'8px', alignItems:'center'}},
                me
                  ? e(React.Fragment,null,
                      e('button',{className:'btn btn-ghost', onClick:()=>api.finds(c.id,'found it!').then(()=>{ loadPublic(); loadAuthed(); toast('Find logged'); })}, 'Log find'),
                      e('button',{className:'btn', style:{background: isFav(c.id)?'#2f8dff':'var(--btn)'}, onClick:()=>api.toggleFav(c.id).then(()=>{ loadAuthed(); toast(isFav(c.id)?'Removed':'Saved'); })}, isFav(c.id)?'★ Unsave':'☆ Save'),
                      e('button',{className:'btn btn-ghost', style:{background: isLiked(c.id)?'#ff6b6b':'transparent', color: isLiked(c.id)?'#fff':'inherit', minWidth:'60px'}, onClick:()=>handleLike(c.id)}, `❤️ ${getLikeCount(c.id)}`)
                    )
                  : e(React.Fragment,null,
                      e('button',{className:'btn btn-warning', onClick:()=>toast('Log in to interact')}, 'Log in to interact'),
                      e('span',{style:{color:'var(--muted)', fontSize:'14px'}}, `❤️ ${getLikeCount(c.id)}`)
                    )
              )
            ),
            e('div',{className:'chips'}, (c.tags || []).map(t => e('span',{className:'chip', key:t}, t))),
            e('div',{className:'coords'}, `${(c.latitude || c.lat || 0).toFixed(5)}, ${(c.longitude || c.lon || 0).toFixed(5)}`)
          )),
          document.getElementById('grid-spot')
        )
      );
    }

    ReactDOM.createRoot(document.createElement('div')).render(React.createElement(App));
  </script>
</body>
</html>
